<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="天前"><meta name="hour-prompt" content="小时前"><meta name="minute-prompt" content="分钟前"><meta name="justnow-prompt" content="刚刚"><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="Clickhouse - 数据迁移" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="背景" /><meta property="og:description" content="背景" /><link rel="canonical" href="https://zcyoop.github.io/posts/Clickhouse-%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/" /><meta property="og:url" content="https://zcyoop.github.io/posts/Clickhouse-%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/" /><meta property="og:site_name" content="Zcyoop" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-01-20T00:29:39+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Clickhouse - 数据迁移" /><meta name="twitter:site" content="@twitter_username" /><meta name="google-site-verification" content="bYaaJN_P1KEMPHSc3NYLCjx75e0bMEvAtt54VYZ3jJw" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-01-20T00:29:39+08:00","datePublished":"2021-01-20T00:29:39+08:00","description":"背景","headline":"Clickhouse - 数据迁移","mainEntityOfPage":{"@type":"WebPage","@id":"https://zcyoop.github.io/posts/Clickhouse-%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/"},"url":"https://zcyoop.github.io/posts/Clickhouse-%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/"}</script><title>Clickhouse - 数据迁移 | Zcyoop</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Zcyoop"><meta name="application-name" content="Zcyoop"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="zh-CN"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://blog-1253533258.cos.ap-shanghai.myqcloud.com/piggo/39327876.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Zcyoop</a></div><div class="site-subtitle font-italic">Zcyoop Blog</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/zcyoop" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['zcy2nn','qq.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>Clickhouse - 数据迁移</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Clickhouse - 数据迁移</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> zcyoop </span> 发表于 <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="2021-01-20, 00:29 +0800" >2021-01-20<i class="unloaded">2021-01-20T00:29:39+08:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2311 字">12 分钟 阅读</span></div></div><div class="post-content"><h2 id="背景">背景</h2><p>​ 数据报表即将上线，需准备一个Clickhouse测试库用作后续开发</p><h2 id="方案调研">方案调研</h2><p>迁移集群实际上就是要把所有数据库（system 除外）的表结构和数据完整的复制一遍。ClickHouse 官方和社区有一些现成的解决方案，也可以自己实现。</p><h3 id="拷贝数据目录">拷贝数据目录</h3><p>先观察一下 ClickHouse 在文件系统上的目录结构（配置文件 <code class="language-plaintext highlighter-rouge">/ect/clickhouse-server/config.xml</code> 里面配置的 <code class="language-plaintext highlighter-rouge">&lt;path&gt;</code>），为了便于查看，只保留了 <code class="language-plaintext highlighter-rouge">data</code> 和 <code class="language-plaintext highlighter-rouge">metadata</code> 目录。</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre>.
├── data
│   ├── default
│   ├── system
│   │   ├── asynchronous_metric_log
│   │   ├── metric_log
│   │   ├── query_log
│   │   ├── query_thread_log
│   │   └── trace_log
├── metadata
│   ├── default
│   │   └── v_table_size.sql
│   ├── default.sql
│   ├── system
│   │   ├── asynchronous_metric_log.sql
│   │   ├── metric_log.sql
│   │   ├── query_log.sql
│   │   ├── query_thread_log.sql
│   │   └── trace_log.sql


</pre></table></code></div></div><ul><li><code class="language-plaintext highlighter-rouge">data</code> 目录里保存的是数据，每个数据库一个目录，内部每个表一个子目录。<li><code class="language-plaintext highlighter-rouge">metadata</code> 目录里保存的是元数据，即数据库和表结构。其中<ul><li><code class="language-plaintext highlighter-rouge">&lt;database&gt;.sql</code> 是 创建数据库的 DDL（<code class="language-plaintext highlighter-rouge">ATTACH DATABASE default ENGINE = Ordinary</code>）<li><code class="language-plaintext highlighter-rouge">&lt;database&gt;/&lt;table&gt;.sql</code> 是建表的 DDL (<code class="language-plaintext highlighter-rouge">ATTACH TABLE ...</code>).</ul></ul><blockquote><p>这里的 DDL 使用的是 <code class="language-plaintext highlighter-rouge">ATTACH</code> 语句，<a href="https://clickhouse.tech/docs/en/sql-reference/statements/attach/">进入文档</a> 查看 ATTACH 的作用及跟 CREATE 的区别</p></blockquote><p>基于这个信息，直接把 <code class="language-plaintext highlighter-rouge">data</code> 和 <code class="language-plaintext highlighter-rouge">metadata</code> 目录（要排除 system）复制到新集群，即可实现数据迁移。用一个小表做测试，验证可行。</p><p>操作流程</p><ol><li>在源集群的硬盘上打包好对应数据库或表的 data 和 metadata 数据<li>拷贝到目标集群对应的目录<li>重启 clickhouse-server</ol><h3 id="使用-remote-表函数">使用 <code class="language-plaintext highlighter-rouge">remote</code> 表函数</h3><p>ClickHouse 除了查询常规的表，还能使用表函数来构建一些特殊的「表」，其中 <a href="https://clickhouse.tech/docs/en/sql-reference/table-functions/remote/">remote 函数</a> 可用于查询另一个 ClickHouse 的表。</p><p>使用方式很简单:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>SELECT * FROM remote('addresses_expr', db, table, 'user', 'password') LIMIT 10;


</pre></table></code></div></div><p>因此，可以借助这个功能实现数据迁移：</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>INSERT INTO &lt;local_database&gt;.&lt;local_table&gt;
SELECT * FROM remote('remote_clickhouse_addr', &lt;remote_database&gt;, &lt;remote_table&gt;, '&lt;remote_user&gt;', '&lt;remote_password&gt;')


</pre></table></code></div></div><p>操作流程</p><ol><li>在源集群的 <code class="language-plaintext highlighter-rouge">system.tables</code> 表查询出数据库、表、DDL、分区、表引擎等信息<li>在目标集群上，运行 DDL 创建表，然后运行上述迁移语句复制数据<li>遍历所有表，执行 2</ol><h3 id="使用-clickhouse-copier">使用 clickhouse-copier</h3><p><a href="https://clickhouse.tech/docs/en/operations/utilities/clickhouse-copier/">Clickhouse-copier</a> 是 ClickHouse 官方提供的一款数据迁移工具，可用于把表从一个集群迁移到另一个（也可以是同一个）集群。Clickhouse-copier 使用 Zookeeper 来管理同步任务，可以同时运行多个 clickhouse-copier 实例。</p><p>使用方式:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>clickhouse-copier --daemon --config zookeeper.xml --task-path /task/path --base-dir /path/to/dir


</pre></table></code></div></div><p>其中 <code class="language-plaintext highlighter-rouge">--config zookeeper.xml</code> 是 Zookeeper 的连接信息，<code class="language-plaintext highlighter-rouge">--task-path /task/path</code> 是 Zookeeper 里任务配置的节点路径。在使用时，需要先定义一个 XML 格式的任务配置文件，上传到 <code class="language-plaintext highlighter-rouge">/task/path/description</code> 里。同步任务是表级别的，可以配置的内容还比较多。Clickhouse-copier 可以监听 <code class="language-plaintext highlighter-rouge">/task/path/description</code> 的变化，动态加载新的配置而不需要重启。</p><p>操作流程</p><ol><li>创建 <code class="language-plaintext highlighter-rouge">zookeeper.xml</code><li>创建任务配置文件，格式见官方文档，每个表都要配置（可使用代码自动生成）<li>把配置文件内容上传到 Zookeeper<li>启动 clickhouse-copier 进程</ol><p>理论上 clickhouse-copier 运行在源集群或目标集群的环境都可以，官方文档推进在源集群，这样可以节省带宽。</p><h3 id="使用-clickhouse-backup">使用 clickhouse-backup</h3><p><a href="https://github.com/AlexAkulov/clickhouse-backup">clickhouse-backup</a> 是社区开源的一个 ClickHouse 备份工具，可用于实现数据迁移。其原理是先创建一个备份，然后从备份导入数据，类似 MySQL 的 mysqldump + SOURCE。这个工具可以作为常规的异地冷备方案，不过有个局限是只支持 MergeTree 系列的表。</p><p>操作流程</p><ol><li>在源集群使用 <code class="language-plaintext highlighter-rouge">clickhouse-backup create</code> 创建备份<li>把备份文件压缩拷贝到目标集群<li>在目标集群使用 <code class="language-plaintext highlighter-rouge">clickhouse-backup restore</code> 恢复</ol><h3 id="对比">对比</h3><div class="table-wrapper"><table><thead><tr><th><th>拷贝数据目录<th>使用 <code>remote</code> 表函数<th>使用 clickhouse-copier<th>使用 clickhouse-backup<tbody><tr><td>操作复杂度<td>较麻烦，需要在两台服务器上操作文件系统并拷贝文件，不方便自动化<td>一般，需要写程序自动化<td>看起来比使用 <code>remote</code> 更复杂一些，主要是生成配置文件比较麻烦<td>类似拷贝数据目录，会更简单一些<tr><td>全量同步<td>支持<td>支持<td>支持<td>支持<tr><td>增量同步<td>不支持<td>支持<td>应该支持<td>不支持<tr><td>迁移视图<td>不支持<td>支持<td>不确定，理论上应该支持<td>不支持<tr><td>性能<td>较好<td>较好<td>不确定，应该比 <code>remote</code> 快<td>不确定<tr><td>局限性<td>不支持集群，很多人工操作<td>不适合大表？应该需要相同的拓扑结构<td>不确定，可能没有<td>只支持 MergeTree 系列</table></div><p>从官方和社区的一些资料综合来看 clickhouse-copier 功能最强大，不过考虑到数据量较少，而且对 clickhouse-copier 有些地方也不是很清楚，最终决定使用 <code class="language-plaintext highlighter-rouge">remote</code> 函数来做数据迁移。</p><p>关于别的数据迁移方案、更多的 clickhouse-copier 使用案例，可参考 Altinity 的博客 <a href="https://altinity.com/blog/2018/8/22/clickhouse-copier-in-practice">Clickhouse-copier in practice</a>.</p><h2 id="使用-remote-函数做数据迁移">使用 <code class="language-plaintext highlighter-rouge">remote</code> 函数做数据迁移</h2><p>使用 <code class="language-plaintext highlighter-rouge">remote</code> 函数还能实现更多特性：</p><ul><li>对于分区表，可逐个分区进行同步，这样实际上同步的最小单位是分区，可以实现增量同步<li>可方便集成数据完整性（行数对比）检查，自动重新同步更新过的表</ul><h3 id="代码">代码</h3><p>代码如下，需要先安装 <a href="https://github.com/mymarilyn/clickhouse-driver">clickhouse-driver</a></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
</pre><td class="rouge-code"><pre>import collections
import datetime
import functools
import logging
import time

from clickhouse_driver import Client

source_conn = Client(host='source-host', user='user', password='password')
target_conn = Client(host='target-host', user='user', password='password')


def format_partition_expr(p):
    if isinstance(p, int):
        return p
    return f"'{p}'"


def execute_queries(conn, queries):
    if isinstance(queries, str):
        queries = queries.split(';')
    for q in queries:
        conn.execute(q.strip())


class Table(object):
    def __init__(self, database, name, ddl, partition_key, is_view):
        self.database = database
        self.name = name
        self.ddl = ddl.replace('CREATE TABLE', 'CREATE TABLE IF NOT EXISTS')
        self.partition_key = partition_key
        self.is_view = is_view

    def exists(self, conn):
        q = f"SELECT name FROM system.tables WHERE database = '{self.database}' AND name = '{self.name}'"
        return len(conn.execute(q)) &gt; 0

    def get_partitions(self, conn):
        partitions = []
        q = f'SELECT {self.partition_key}, count() FROM {self.identity} GROUP BY {self.partition_key} ORDER BY {self.partition_key}'
        partitions = collections.OrderedDict(conn.execute(q))
        return partitions

    def get_total_count(self, conn):
        q = f'SELECT COUNT() FROM {self.identity}'
        return conn.execute(q)[0][0]

    def check_consistency(self):
        if not self.exists(target_conn):
            return False, None

        source_ttl_count = self.get_total_count(source_conn)
        target_ttl_count = self.get_total_count(target_conn)
        if source_ttl_count == target_ttl_count:
            return True, None

        if not self.partition_key:
            return False, None

        source_partitions = self.get_partitions(source_conn)
        target_partitions = self.get_partitions(target_conn)
        bug_partitions = []
        for p, c in source_partitions.items():
            if p not in target_partitions or c != target_partitions[p]:
                bug_partitions.append(p)
        return False, bug_partitions

    def create(self, replace=False):
        target_conn.execute(f'CREATE DATABASE IF NOT EXISTS {self.database}')
        if self.is_view:
            replace = True
        if replace:
            target_conn.execute(f'DROP TABLE IF EXISTS {self.identity}')
        target_conn.execute(self.ddl)

    def copy_data_from_remote(self, by_partition=True):
        self.create()
        if self.is_view:
            logging.info('ignore view %s', self.identity)
            return

        is_identical, bug_partitions = self.check_consistency()
        if is_identical:
            logging.info('table %s has the same number of rows, skip', self.identity)
            return

        if self.partition_key and by_partition:
            for p in bug_partitions:
                logging.info('copy partition %s=%s', self.partition_key, p)
                self._copy_partition_from_remote(p)
        else:
            self._copy_table_from_remote()

    def _copy_table_from_remote(self):
        queries = f'''
        DROP TABLE {self.identity};
        {self.ddl};
        INSERT INTO {self.identity}
        SELECT * FROM remote('{source_conn.host}', {self.identity}, '{source_conn.user}', '{source_conn.password}')
        '''
        execute_queries(target_conn, queries)

    def _copy_partition_from_remote(self, partition):
        partition = format_partition_expr(partition)
        queries = f'''
        ALTER TABLE {self.identity} DROP PARTITION {partition};
        INSERT INTO {self.identity}
        SELECT * FROM remote('{source_conn.host}', {self.identity}, '{source_conn.user}', '{source_conn.password}')
        WHERE {self.partition_key} = {partition}
        '''
        execute_queries(target_conn, queries)

    def copy_to_another_table(self, database, name=None):
        if not name:
            name = self.name
        assert not (self.database == database and self.name == name)
        if self.partition_key:
            partitions = self.get_partitions(target_conn)
            queries = [f'CREATE TABLE IF NOT EXISTS {database}.{name} AS {self.identity}']
            for p in partitions.keys():
                expr = format_partition_expr(p)
                queries.append(f'ALTER TABLE {database}.{name} DROP PARTITION {expr}')
                queries.append(f'ALTER TABLE {database}.{name} ATTACH PARTITION {expr} FROM {self.identity}')
            execute_queries(target_conn, queries)
        else:
            queries = f'''
            DROP TABLE IF EXISTS {database}.{name};
            CREATE TABLE {database}.{name} AS {self.identity};
            INSERT INTO {database}.{name} SELECT * FROM {self.identity};
            '''
            execute_queries(target_conn, queries)

    @property
    def identity(self):
        return f'{self.database}.{self.name}'

    def __str__(self):
        return self.identity

    __repr__ = __str__


def get_all_tables() -&gt; [Table]:
    
    q = '''
    SELECT database, name, create_table_query, partition_key, engine = 'View' AS is_view
    FROM system.tables
    WHERE database NOT IN ('system')
    ORDER BY if(engine = 'View', 999, 0), database, name
    '''
    rows = source_conn.execute(q)
    tables = [Table(*values) for values in rows]
    return tables


def copy_remote_tables(tables):
    for idx, t in enumerate(tables):
        start_time = datetime.datetime.now()
        logging.info('&gt;&gt;&gt;&gt; start to migrate table %s, progress %s/%s', t.identity, idx+1, len(tables))
        t.copy_data_from_remote()
        logging.info('&lt;&lt;&lt;&lt; migrated table %s in %s', t.identity, datetime.datetime.now() - start_time)


def with_retry(max_attempts=5, backoff=120):
    def decorator(f):
        @functools.wraps(f)
        def inner(*args, **kwargs):
            attempts = 0
            while True:
                attempts += 1
                logging.info('start attempt #%s', attempts)
                try:
                    f(*args, **kwargs)
                except Exception as e:
                    if attempts &gt;= max_attempts:
                        raise e
                    logging.exception('caught exception')
                    time.sleep(backoff)
                else:
                    break
        return inner
    return decorator


@with_retry(max_attempts=10, backoff=60)
def main():
    tables = get_all_tables()
    logging.info('got %d tables: %s', len(tables), tables)
    copy_remote_tables(tables)


if __name__ == '__main__':
    main()


</pre></table></code></div></div><p>使用方式：直接运行即可，挂了重跑，不会有副作用。</p><h3 id="局限性">局限性</h3><p>​ 仅通过对比行数来判断数据同步完整，没有比较内部数据的一致性，因此如果上游表行数不变，更新了部分字段，将无法自动识别，需要先从目标库里把表删掉重新同步。</p><p>​ 必须为两个相同的库，例如从阿里云Clickhouse迁移数据到本地基本就不可行。</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/'>数据库</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/clickhouse/" class="post-tag no-text-decoration" >clickhouse</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Clickhouse - 数据迁移 - Zcyoop&url=https://zcyoop.github.io/posts/Clickhouse-%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Clickhouse - 数据迁移 - Zcyoop&u=https://zcyoop.github.io/posts/Clickhouse-%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Clickhouse - 数据迁移 - Zcyoop&url=https://zcyoop.github.io/posts/Clickhouse-%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>最近更新</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Python-%E7%BC%BA%E5%B0%91C++%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/">Python - 缺少C++构建工具</a><li><a href="/posts/Docker-Remote-API%E7%9A%84TLS%E8%AE%A4%E8%AF%81&Portainer%E9%85%8D%E7%BD%AE/">Docker Remote API的TLS认证&Portainer配置</a><li><a href="/posts/Kafka-%E5%89%AF%E6%9C%AC%E6%9C%BA%E5%88%B6/">Kafka - 副本机制</a><li><a href="/posts/Flink-Window-%E6%A6%82%E5%BF%B5&%E4%BD%BF%E7%94%A8/">Flink - Window 概念&使用</a><li><a href="/posts/Java%E5%B9%B6%E5%8F%91-CompletableFuture%E8%AF%A6%E8%A7%A3/">Java 并发 - CompletableFuture详解</a></ul></div><div id="access-tags"> <span>热门标签</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/hadoop/">hadoop</a> <a class="post-tag" href="/tags/spark/">spark</a> <a class="post-tag" href="/tags/flink/">flink</a> <a class="post-tag" href="/tags/hive/">hive</a> <a class="post-tag" href="/tags/mysql/">mysql</a> <a class="post-tag" href="/tags/jvm/">jvm</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">机器学习</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">文章内容</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Clickhouse-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"><div class="card-body"> <span class="timeago small" >2020-12-21<i class="unloaded">2020-12-21T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Clickhouse 常用命令</h3><div class="text-muted small"><p> 数据表基本操作 -- 追加新字段 ALTER TABLE tb_name ADD COLUMN [IF NOT EXISTS] name [type] [default_expr] [AFTER name_after] ALTER TABLE testtable ADD COLUMN colum1 String DEFAULT 'defaultvalue'; -- 修改字段类型 ALTE...</p></div></div></a></div><div class="card"> <a href="/posts/MongoDB-%E5%9C%A8%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F%E4%B8%8BCount%E4%B9%9F%E7%9C%9F%E5%AE%9E%E6%95%B0%E6%8D%AE%E9%87%8F%E4%B8%8D%E4%B8%80%E8%87%B4/"><div class="card-body"> <span class="timeago small" >2020-11-22<i class="unloaded">2020-11-22T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>MongoDB 在集群模式下Count也真实数据量不一致</h3><div class="text-muted small"><p> 1. 背景 在同步Clickhouse数据时，发现MongoDB数据量与Clickhouse数据量不一致，经同事提醒，可能是分片MongoDB集群Count不一致导致吗，于是Google查询相关资料 2.相关信息 通过查看官网发现中有解释这种现象的解释 On a sharded cluster, db.collection.count() can result in ...</p></div></div></a></div><div class="card"> <a href="/posts/MySQL-MySQL%E4%B8%AD%E7%9A%84%E7%B4%A2%E5%BC%95/"><div class="card-body"> <span class="timeago small" >2021-08-18<i class="unloaded">2021-08-18T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>MySQL - MySQL中的索引</h3><div class="text-muted small"><p> 1. 概述 定义：索引是存储引擎用于快速找到记录的一种数据结构。举例说明：如果查找一本书中的某个特定主题，一般会先看书的目录（类似索引），找到对应页面。在MySQL，存储引擎采用类似的方法使用索引，高效获取查找的数据。 索引的分类 从存储结构上来划分 Btree 索引（B+tree，B-tree) 哈希索引 full-index 全文...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Clickhouse-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" class="btn btn-outline-primary" prompt="上一篇"><p>Clickhouse 常用命令</p></a> <a href="/posts/Socks5%E4%BB%A3%E7%90%86%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/" class="btn btn-outline-primary" prompt="下一篇"><p>Socks5代理工作原理</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/zcyoop">zcyoop</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">热门标签</h4><a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/hadoop/">hadoop</a> <a class="post-tag" href="/tags/spark/">spark</a> <a class="post-tag" href="/tags/flink/">flink</a> <a class="post-tag" href="/tags/hive/">hive</a> <a class="post-tag" href="/tags/mysql/">mysql</a> <a class="post-tag" href="/tags/jvm/">jvm</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">机器学习</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-WR4TKVL8XR"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-WR4TKVL8XR'); }); </script>
